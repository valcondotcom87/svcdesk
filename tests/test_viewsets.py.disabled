"""
ViewSet CRUD operation tests
"""
import pytest
from django.test import TestCase
from rest_framework import status
from rest_framework.test import APIRequestFactory, APIClient

from apps.core.models import CustomUser
from apps.incidents.models import Incident
from apps.service_requests.models import ServiceRequest
from apps.problems.models import Problem
from apps.changes.models import Change
from apps.assets.models import Asset

from tests.factories import (
    OrganizationFactory, CustomUserFactory, IncidentFactory, TeamFactory,
    ServiceRequestFactory, ProblemFactory, ChangeFactory, AssetFactory
)


@pytest.mark.viewset
@pytest.mark.django_db
class TestIncidentViewSet:
    """Test Incident CRUD operations"""
    
    def setup_method(self):
        """Setup test data"""
        self.client = APIClient()
        self.org = OrganizationFactory()
        self.user = CustomUserFactory(organization=self.org)
        
        # Authenticate
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {str(refresh.access_token)}')
    
    def test_list_incidents(self):
        """Test GET /incidents/ lists incidents"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        response = self.client.get('/api/v1/incidents/')
        
        assert response.status_code == status.HTTP_200_OK
        assert 'results' in response.json() or isinstance(response.json(), list)
    
    def test_create_incident(self):
        """Test POST /incidents/ creates incident"""
        data = {
            'title': 'New Incident',
            'description': 'Test description',
            'priority': 'high',
            'urgency': 'high',
            'impact': 'high',
            'requester': self.user.id
        }
        
        response = self.client.post('/api/v1/incidents/', data)
        
        # Should succeed or fail with proper error
        assert response.status_code in [
            status.HTTP_201_CREATED,
            status.HTTP_400_BAD_REQUEST,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_retrieve_incident(self):
        """Test GET /incidents/{id}/ retrieves incident"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        response = self.client.get(f'/api/v1/incidents/{incident.id}/')
        
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_404_NOT_FOUND]
    
    def test_update_incident(self):
        """Test PATCH /incidents/{id}/ updates incident"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        data = {
            'title': 'Updated Title',
            'status': 'assigned'
        }
        
        response = self.client.patch(f'/api/v1/incidents/{incident.id}/', data)
        
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_delete_incident(self):
        """Test DELETE /incidents/{id}/ deletes incident (soft delete)"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        response = self.client.delete(f'/api/v1/incidents/{incident.id}/')
        
        assert response.status_code in [
            status.HTTP_204_NO_CONTENT,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_resolve_incident_action(self):
        """Test POST /incidents/{id}/resolve/ resolves incident"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        data = {
            'resolution_notes': 'Issue resolved',
            'resolution_code': 'RESOLVED'
        }
        
        response = self.client.post(f'/api/v1/incidents/{incident.id}/resolve/', data)
        
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_filter_incidents_by_status(self):
        """Test filtering incidents by status"""
        IncidentFactory(organization=self.org, status='open', created_by=self.user)
        IncidentFactory(organization=self.org, status='closed', created_by=self.user)
        
        response = self.client.get('/api/v1/incidents/?status=open')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_search_incidents(self):
        """Test searching incidents by title"""
        IncidentFactory(
            organization=self.org,
            ticket_number='TEST-001',
            title='Critical Production Issue',
            created_by=self.user
        )
        
        response = self.client.get('/api/v1/incidents/?search=Production')
        
        assert response.status_code == status.HTTP_200_OK


@pytest.mark.viewset
@pytest.mark.django_db
class TestServiceRequestViewSet:
    """Test ServiceRequest CRUD operations"""
    
    def setup_method(self):
        """Setup test data"""
        self.client = APIClient()
        self.org = OrganizationFactory()
        self.user = CustomUserFactory(organization=self.org)
        
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {str(refresh.access_token)}')
    
    def test_list_service_requests(self):
        """Test listing service requests"""
        sr = ServiceRequestFactory(organization=self.org, created_by=self.user)
        
        response = self.client.get('/api/v1/service-requests/')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_create_service_request(self):
        """Test creating service request"""
        data = {
            'title': 'New Service Request',
            'description': 'Test request',
            'priority': 'high',
            'requester': self.user.id
        }
        
        response = self.client.post('/api/v1/service-requests/', data)
        
        assert response.status_code in [
            status.HTTP_201_CREATED,
            status.HTTP_400_BAD_REQUEST,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_submit_service_request(self):
        """Test submitting service request"""
        sr = ServiceRequestFactory(organization=self.org, created_by=self.user)
        
        response = self.client.post(f'/api/v1/service-requests/{sr.id}/submit/')
        
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]


@pytest.mark.viewset
@pytest.mark.django_db
class TestUserViewSet:
    """Test User CRUD operations"""
    
    def setup_method(self):
        """Setup test data"""
        self.client = APIClient()
        self.org = OrganizationFactory()
        self.user = CustomUserFactory(organization=self.org)
        
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {str(refresh.access_token)}')
    
    def test_list_users(self):
        """Test listing users"""
        response = self.client.get('/api/v1/users/')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_get_current_user(self):
        """Test getting current user profile"""
        response = self.client.get('/api/v1/users/me/')
        
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_404_NOT_FOUND]
    
    def test_change_password(self):
        """Test changing password"""
        data = {
            'old_password': self.user.password,
            'new_password': 'newpass123',
            'confirm_password': 'newpass123'
        }
        
        response = self.client.post(f'/api/v1/users/{self.user.id}/change_password/', data)
        
        # Will likely fail because we need the actual password, not the hash
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_400_BAD_REQUEST,
            status.HTTP_403_FORBIDDEN,
            status.HTTP_404_NOT_FOUND
        ]


@pytest.mark.viewset
@pytest.mark.django_db
class TestViewSetFiltering:
    """Test ViewSet filtering capabilities"""
    
    def setup_method(self):
        """Setup test data"""
        self.client = APIClient()
        self.org = OrganizationFactory()
        self.user = CustomUserFactory(organization=self.org)
        
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {str(refresh.access_token)}')
    
    def test_filter_by_priority(self):
        """Test filtering incidents by priority"""
        IncidentFactory(organization=self.org, priority='high', created_by=self.user)
        IncidentFactory(organization=self.org, priority='low', created_by=self.user)
        
        response = self.client.get('/api/v1/incidents/?priority=high')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_filter_by_assigned_to(self):
        """Test filtering incidents by assignee"""
        other_user = CustomUserFactory(organization=self.org)
        
        IncidentFactory(organization=self.org, assigned_to=self.user, created_by=self.user)
        IncidentFactory(organization=self.org, assigned_to=other_user, created_by=self.user)
        
        response = self.client.get(f'/api/v1/incidents/?assigned_to={self.user.id}')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_search_by_ticket_number(self):
        """Test searching by ticket number"""
        IncidentFactory(
            organization=self.org,
            ticket_number='TEST-INC-00001',
            created_by=self.user
        )
        
        response = self.client.get('/api/v1/incidents/?search=TEST-INC-00001')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_ordering_by_created_date(self):
        """Test ordering results"""
        response = self.client.get('/api/v1/incidents/?ordering=-created_at')
        
        assert response.status_code == status.HTTP_200_OK


@pytest.mark.viewset
@pytest.mark.django_db
class TestViewSetCustomActions:
    """Test ViewSet custom actions"""
    
    def setup_method(self):
        """Setup test data"""
        self.client = APIClient()
        self.org = OrganizationFactory()
        self.user = CustomUserFactory(organization=self.org)
        
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {str(refresh.access_token)}')
    
    def test_incident_close_action(self):
        """Test closing incident"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        response = self.client.post(f'/api/v1/incidents/{incident.id}/close/')
        
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_incident_escalate_action(self):
        """Test escalating incident"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        response = self.client.post(f'/api/v1/incidents/{incident.id}/escalate/')
        
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]
    
    def test_add_comment_action(self):
        """Test adding comment to incident"""
        incident = IncidentFactory(organization=self.org, created_by=self.user)
        
        data = {
            'text': 'This is a test comment',
            'is_internal': False
        }
        
        response = self.client.post(f'/api/v1/incidents/{incident.id}/add_comment/', data)
        
        assert response.status_code in [
            status.HTTP_201_CREATED,
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]


@pytest.mark.viewset
@pytest.mark.django_db
class TestAssetViewSet:
    """Test Asset CRUD operations"""
    
    def setup_method(self):
        """Setup test data"""
        self.client = APIClient()
        self.org = OrganizationFactory()
        self.user = CustomUserFactory(organization=self.org)
        
        from rest_framework_simplejwt.tokens import RefreshToken
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {str(refresh.access_token)}')
    
    def test_list_assets(self):
        """Test listing assets"""
        asset = AssetFactory(organization=self.org, current_owner=self.user)
        
        response = self.client.get('/api/v1/assets/')
        
        assert response.status_code == status.HTTP_200_OK
    
    def test_transfer_asset(self):
        """Test transferring asset"""
        asset = AssetFactory(organization=self.org, current_owner=self.user)
        other_user = CustomUserFactory(organization=self.org)
        
        data = {
            'to_user_id': other_user.id,
            'transfer_notes': 'Transferred for project'
        }
        
        response = self.client.post(f'/api/v1/assets/{asset.id}/transfer/', data)
        
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_404_NOT_FOUND,
            status.HTTP_403_FORBIDDEN
        ]
